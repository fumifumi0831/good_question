# アーキテクチャ決定記録 (ADR)

## [ADR-001] インタビュー不甲斐なさ解消のための「デジタル上司」基盤の選定

### 背景
- **現状の課題**: インタビュー中に複雑な情報を整理しながら適切な質問を出す脳内負荷が高く、初心者が「真因」に到達するのが困難である。
- **目的**: ユーザーの脳内 CPU 負荷を軽減し、上司が横にいるような安心感と具体的な「気づき」を提供すること。
- **アーキテクチャドライバ**:
  - 低遅延な対話（トレーニングの没入感）。
  - 各ユーザーの「思考の癖」の蓄積と縦軸成長分析。
  - 既存の Next.js 資産の継承。
  - セキュリティ・プライバシー（個人の学習ログの保護）。

### 決定内容
- **アーキテクチャパターン**: サーバーレス・ハイブリッド構成（Next.js API Routes + Client-side Storage）。
- **主要コンポーネント構成**: 
  - **推理エンジン**: Gemini 2.0 Flash（API 経由）。
  - **永続化管理**: Dexie.js (IndexedDB) によるローカルファーストの学習データ蓄積。
  - **状態管理**: React 19 + Framer Motion による動的 UI 管理。
- **データフロー**: 
  1. クライアントからのメッセージ（またはヘルプ要求）を Next.js API 経由で Gemini へ送信。
  2. Gemini 側で「演技（Facilitator）」と「分析（Analyst）」の役割をプロンプトファイル（systemprompt.md / evalprompt.md）により切り替え。
  3. 応答内容をクライアント側で受信し、Dexie.js に永続化しつつ UI を更新。

### ステータス
**承認済み**

### 選定理由
- **Gemini 2.0 Flash**: インタビューはリアルタイム性が生命線であり、高速な追従性と高い論理構成力を両立する同モデルが最適。
- **Dexie.js (Local First)**: 
  - メリット：サーバーサイドの DB 運用コストがゼロ。ユーザーの秘匿性の高い学習ログをサーバーに送らず、ブラウザ内で完結させることでプライバシー要件をクリア。
  - 過去比較：IndexedDB の直接操作に比べ、開発速度とメンテナンス性が格段に向上。
- **Next.js**: 既存の資産を活かしつつ、API Route を介することで AI API キーをセキュアに秘匿可能。

### 影響
- **ポジティブ**: インフラコストを最小限に抑えつつ（API 使用料のみ）、高度なパーソナライズが可能。
- **ネガティブ**: ブラウザのキャッシュクリア等によりデータが消失するリスクがある（将来的な同期機能の検討が必要）。
- **開発への影響**: プロンプトエンジニアリングがロジックを中心となるため、コードとプロンプトの責任分解（ファイルの切り離し）が重要となる。

### 非機能要件対応
- **可用性**: Vercel + Google AI Studio の稼働率に準拠。
- **性能**: ヘルプ実行からアドバイス提示まで 5 秒以内を目標値に設定。
- **セキュリティ**: API キーの秘匿（API Route 経由）、個人データのローカル保持。
- **保守性**: プロンプトを独立した `md` ファイルとして管理することで、AI の振る舞いだけを単独で改善可能。

### 代替案
- **Python / FastAPI + RDB (PostgreSQL)**:
  - 却下理由: 小規模な個人学習ツールに対してインフラ構成が重厚になりすぎ、保守コスト（DB 運用、サーバー維持）が高まるため。
- **OpenAI (GPT-4o)**:
  - 却下理由: 多言語能力と複雑なコンテキスト維持において Gemini 2.0 Flash のコストパフォーマンスとレスポンス速度が優位と判断。

### 技術スタック
- **Frontend**: Next.js、Tailwind CSS 4.0、Framer Motion
- **Database**: Dexie.js (IndexedDB)
- **AI Backend**: Google Generative AI (Gemini 2.0 Flash)
- **Deployment**: Vercel

### 主要コンポーネント詳細
- **Facilitator (systemprompt.md)**: 迷走役員を演じ、ユーザーの質問を評価する。
- **Analyst (evalprompt.md)**: 終了後のロジカル添削と過去比較分析を担当。
- **Store Adapter (lib/storage.ts)**: IndexedDB との I/O 境界。

### 実装方針
- **開発環境**: Cursor (IDE) + npm
- **テスト戦略**: 最も重要なヘルプ機能の「整理品質」を評価するためのテストプロンプト集（Golden Dataset）を作成。
- **デプロイ戦略**: Vercel への継続的デプロイ（CI/CD）。

### リスクと対策
- **リスク**: プロンプトの Instruction Drift（指示の逸脱）。
- **対応策**: 役割ごとにプロンプトファイルを完全に分離し、各 API コール時のシステムコンテキストを純粋に保つ。

### 備考
将来的に複数端末での同期が必要になった場合は、Google Drive API 等を利用したユーザー管理なしの外部バックアップ機能の追加を検討する。
