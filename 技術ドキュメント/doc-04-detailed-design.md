# 詳細設計書 (Detailed Design)

## 1. コンポーネント・ロジック設計

### 1.1 セッション開始前ロジック (Setup Phase)
ユーザーの「やる気」と「弱点克服」を最大化するための動的生成プロセス。
- **入力**: `userStats` (過去の評価スコア、抽出された思考の癖、前回の反省点)。
- **プロセス**:
    1.  AI が過去の傾向を分析。
    2.  今回のトレーニングにおける「上司の事前ブリーフィング（重点指導項目）」を生成。
    3.  ユーザーの弱点を突くような性質を持つ「隠された真因（Root Cause）」のガチャ生成。
- **出力**: `BriefingMessage`, `HiddenScenarioID`, `ScenarioLogic`.

### 1.2 ヘルプボタンの判断アルゴリズム (Help Phase)
「上司の助け舟」を体現する状況整理ロジック。
- **イベント**: トレーニング中にユーザーが「ヘルプボタン」を押下。
- **プロセス**:
    1.  直近 5 往復の対話ログとシークレットな真因データを AI (`Analyser` ロール) に送信。
    2.  AI はクライアントの現在の「心理的障壁（なぜ話が停滞しているか）」を言語化。
    3.  ユーザーの選択（ヒント or 模範解答）に応じて、気づきまたは具体的な問いかけ案を提示。
- **UIフィードバック**: ボタンが脈打つ（パルス）アニメーションで可用性を通知。

### 1.3 終了後・垂直成長分析 (Review Phase)
「不甲斐なさ」を具体的な学びに変える振り返りロジック。
- **プロセス**:
    1.  セッション全ログを AI に送信し、3軸（構造化・共感・仮説）でスコアリング。
    2.  **特定の不適切な質問の抽出**: 「この一言がクライアントを閉ざさせた」という瞬間を特定。
    3.  **Better Version の生成**: 同じ場面で「どう聞けばよかったか」の具体的な言い換え案を提示。
    4.  **過去対比**: 「前回より共感ステップがスムーズになった」等のポジティブなフィードバックを生成。

## 2. プロンプト設計方針 (Role Separation)

AI の役割を明確に分け、指示の逸脱（Instruction Drift）を防止する。

| ロール名 | プロンプトファイル | 主な責務 |
| :--- | :--- | :--- |
| **Facilitator** | `systemprompt.md` | 迷走役員などのキャラクターを演じる。ユーザーの問いに答える。 |
| **Mentor** | `setup_prompt.md` | 事前ブリーフィング生成と動的シナリオ（ガチャ）の構築。 |
| **Helper** | `help_prompt.md` | 煮詰まった際の状況整理と、ヒント・模範解答の提示。 |
| **Reviewer** | `evalprompt.md` | 3軸評価、ピンポイントな言い換え案、成長分析。 |

## 3. シナリオ・ガチャの構成要素
動的シナリオ生成時のランダム変数：
- **キャラクターの感情背景**: 社長への忖度、ITへの恐怖心、自己保身、現場への愛。
- **ボトルネックの所在**: 組織構造、非効率な業務ルール、人間関係の不和。
- **難易度スパイク**: 話を逸らす、専門用語をわざと使う、沈黙する。

## 4. UI/UX 演出詳細
- **パルストリガー**: 3往復以上進展がない、または真因到達度が停滞している場合にヘルプボタンが脈打つ。
- **エラーメッセージ演出**: Gemini API のレート制限時は、「上司は別件の緊急会議（役員会）に入っており、5分ほど戻りません」と表示。

## 5. データ永続化詳細 (Dexie.js 利用)
- 50件上限の管理ロジック：
    - `db.gameSessions.orderBy('timestamp').reverse().offset(50).modify({ status: 'archived' })` 等により、古いデータを管理。
- ヘルプ利用フラグの保存により、評価レポートで「ここは上司の助けがあったね」と振り返り可能にする。
