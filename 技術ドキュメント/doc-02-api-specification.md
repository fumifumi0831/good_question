# API仕様書 (`/api/chat`)

## 1. API 概要
本 API は、トレーニング中のロールプレイ（Facilitator）、詰まった際の助言（Helper）、および終了後の添削（Reviewer）の3つのモードを切り替えて機能します。

## 2. 基本仕様
- **エンドポイント**: `POST /api/chat`
- **形式**: JSON (Request / Response)
- **認証**: サーバー側環境変数 (GOOGLE_AI_API_KEY) を使用。

## 3. リクエスト定義

### ボディ構造
| フィールド名 | 型 | 必須 | 説明 |
| :--- | :--- | :--- | :--- |
| `mode` | string | ○ | `training`, `help`, `evaluation` のいずれか |
| `messages` | array | ○ | チャット履歴。Role(`user`, `assistant`)とContentのペア |
| `context` | object | ○ | シナリオ設定（業界、テーマ、難易度等） |
| `stats` | object | △ | `mode=evaluation` 時、過去の評価スコアや傾向を含める |

### モード別リクエスト方針
- **`training`**: 直近15往復程度のメッセージを送信。
- **`help`**: 直近5往復程度のメッセージを送信。ポップアップ表示用の要約・助言を要求。
- **`evaluation`**: セッション内の**全ログ**、および `stats`（過去の傾向）を送信。

## 4. レスポンス定義

### 成功レスポンス (200 OK)
```json
{
  "content": "AIからの応答本文 (Markdown形式)",
  "metrics": {
    "reachability": 75, // 真因到達度 (%)
    "helpCount": 2      // (helpモード時のみ) カウント用
  },
  "evaluation": {      // evaluationモード時のみ
    "score": { "structure": 80, "empathy": 70, "hypothesis": 85 },
    "feedback": "...",
    "knowledgeNotes": ["思考の癖1", "思考の癖2"]
  }
}
```

## 5. 専門的な設計判断と実装方針

### 5.1 評価時のコンテキスト管理
- **ログの送信について**: 「過去の評価統計」を送るのは成長分析に有用ですが、**「そのセッションの全ログ」**も送ることを強く推奨します。
- **理由**: 「なぜその評価になったのか」の具体的・ロジカルな添削（例：Q3の発言をクリップする）を行うためには、AI がやり取りの全行程を詳細に把握している必要があるためです。

### 5.2 ヘルプ機能の連携
- **UI連携**: `help` モードの応答はフロントエンドでポップアップ（モーダルまたは吹き出し）として表示。
- **履歴への影響**: ヘルプの応答内容は `chatMessages` テーブルには保存するが、通常のチャット欄には流さず「ヘルプ履歴」として管理。

### 5.3 エラーハンドリング (演出)
- **Gemini レート制限 (429 Error)**: 
    - ステータスコード: `429`
    - フロントエンド演出: 「上司は現在、別件の会議（レート制限）に入っています。数分後にまた声をかけてください。」といったメッセージを表示。

## 6. セキュリティ
- クライアントから API キーを送信することは禁止。
- 全ての API リクエストは Vercel Serverless Function 内で Gemini API キーを付与して中継する。
