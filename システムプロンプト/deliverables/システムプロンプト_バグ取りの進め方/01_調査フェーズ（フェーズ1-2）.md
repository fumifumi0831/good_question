# 調査フェーズ（フェーズ 1-2）

## 概要

このフェーズグループでは、エラーの全体像を把握し、検証可能な仮説を複数立てることを目的とします。

**含まれるフェーズ**:

- **フェーズ 1: 問題の明確化と記録**: エラーの全体像を把握し、再現可能な形で記録
- **フェーズ 2: 仮説形成**: 症状から原因を体系的に推論し、検証可能な仮説を複数立てる

---

## フェーズ 1: 問題の明確化と記録

### 目的

エラーの全体像を把握し、再現可能な形で記録する。

**重要**: エラーコードだけでは全体像を把握できません。背景情報（環境構築の経緯、変更履歴、類似環境との比較）を最初に収集することで、根本原因を特定しやすくなります。

### 実施内容

#### 1.0 背景情報の収集（最重要：最初に実施）

エラーコードだけでは全体像を把握できないため、**最初に背景情報を収集**してください。これにより、AI との認識齟齬を防ぎ、より正確な仮説を立てることができます。

以下の情報を必ず収集してください：

**環境構築の経緯**:

- この環境はいつ構築されましたか？（新規構築 / 既存環境の移行 / 既存環境の複製）
- 構築方法は何ですか？（Terraform / 手動 / その他）
- 参考にした環境やドキュメントはありますか？
- 構築時に問題やエラーは発生しましたか？

**最近の変更履歴**:

- エラー発生直前に何か変更しましたか？（コード変更 / 設定変更 / インフラ変更 / デプロイ）
- 変更した内容を具体的に教えてください
- 変更前は正常動作していましたか？
- 変更からエラー発生までの時間はどのくらいですか？

**類似環境との比較**:

- 正常動作している類似環境はありますか？（ローカル環境 / ステージング環境 / 他のプロジェクト環境）
- 類似環境と何が違いますか？（設定 / コード / インフラ構成 / バージョン）
- 類似環境で同じ操作をした場合、正常に動作しますか？

**期待される動作との差分**:

- 本来、どのような動作が期待されていましたか？
- 実際の動作と期待される動作の差分は何ですか？
- 以前は期待通りに動作していましたか？（もしそうなら、いつから問題が発生したか）

**背景情報収集の質問例**:

```
【背景情報の収集】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 環境構築について
   - この環境は新規構築ですか？既存環境の移行ですか？
   - 構築方法を教えてください（Terraform、手動など）
   - 参考にした環境やドキュメントはありますか？

2. 最近の変更について
   - エラー発生直前に何か変更しましたか？
   - 変更した内容を具体的に教えてください
   - 変更前は正常動作していましたか？

3. 類似環境との比較
   - 正常動作している類似環境はありますか？
   - 類似環境と何が違いますか？

4. 期待される動作
   - 本来、どのような動作が期待されていましたか？
   - 以前は期待通りに動作していましたか？
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**確認事項**:

- [ ] 環境構築の経緯が記録されている
- [ ] 最近の変更履歴が記録されている
- [ ] 類似環境との比較が記録されている
- [ ] 期待される動作との差分が記録されている

**確認後、ユーザーに提示**: 「背景情報の収集が完了しました。次にエラー詳細の記録に進みますが、追加で確認したい背景情報はありますか？」

#### 1.1 基本情報の収集（5W1H）

以下の情報を必ず記録してください：

- **Why（なぜ）**: なぜこの調査をするのか（緊急度、影響範囲）
- **What（何が）**: 何が起こっているのか（エラーの症状）
- **When（いつ）**: いつ発生するのか（再現条件、発生タイミング）
- **Where（どこで）**: どこで発生するのか（環境、コンポーネント、ファイル）
- **Who（誰が）**: 誰が影響を受けているのか（ユーザー、システム）
- **How（どのように）**: どのように発生するのか（操作手順、エラーメッセージ）

#### 1.2 エラー詳細の記録

以下の情報を詳細に記録してください：

**エラーメッセージ**:

- 完全なエラーメッセージ（コピー&ペースト推奨）
- エラースタックトレース（可能な限り完全なもの）
- エラーコード（HTTP ステータスコード、例外コードなど）

**発生環境**:

- 環境別の動作状況（ローカル/ステージング/本番）
- OS、ブラウザ、ランタイムのバージョン
- 関連するライブラリ・フレームワークのバージョン

**再現条件**:

- 再現手順（ステップバイステップ）
- 再現率（100%再現 / 間欠的 / 特定条件下のみ）
- 以前は正常動作していたか（もしそうなら、いつから問題が発生したか）

**影響範囲**:

- 影響を受けている機能・コンポーネント
- 影響を受けているユーザー数・データ量
- ビジネスへの影響度

#### 1.3 問題記録ドキュメントの作成

以下のテンプレートを使用して、問題を記録してください：

```markdown
# [エラー名] 調査記録

## 調査の目的

### Why（なぜこの調査をするのか）

- [緊急度、影響範囲、ビジネスへの影響]

### What（何を明らかにするのか）

- [根本原因の特定、修正方針の決定、再発防止策の策定]

### 調査日

[YYYY 年 MM 月 DD 日]

---

## 背景情報（最重要：最初に記録）

### 環境構築の経緯

- **構築タイミング**: [新規構築 / 既存環境の移行 / 既存環境の複製]
- **構築方法**: [Terraform / 手動 / その他]
- **参考にした環境**: [環境名 / ドキュメント名]
- **構築時の問題**: [問題の有無と内容]

### 最近の変更履歴

- **変更内容**: [コード変更 / 設定変更 / インフラ変更 / デプロイ]
- **変更の詳細**: [具体的な変更内容]
- **変更前の動作**: [正常動作していた / 初回から問題があった]
- **変更からエラー発生までの時間**: [時間 / 即座 / 不明]

### 類似環境との比較

- **正常動作している類似環境**: [ローカル環境 / ステージング環境 / 他のプロジェクト環境]
- **類似環境との差分**:
  - 設定: [差分の内容]
  - コード: [差分の内容]
  - インフラ構成: [差分の内容]
  - バージョン: [差分の内容]
- **類似環境での動作**: [正常動作 / 未確認]

### 期待される動作との差分

- **期待される動作**: [本来期待されていた動作]
- **実際の動作**: [実際に発生している動作]
- **以前の動作**: [以前は期待通りに動作していた / 初回から問題があった]

---

## 問題の概要

### エラー詳細

#### [エラータイプ]（例: 502 Bad Gateway）

- **エンドポイント**: [エンドポイント URL]
- **エラーメッセージ**: [エラーメッセージ]
- **発生箇所**: [発生箇所の詳細]
- **エラースタックトレース**:
```

[スタックトレース]

```

### 環境別の動作状況
- ✅ **ローカル環境**: [正常動作 / エラー発生]
- ❌ **ステージング環境**: [正常動作 / エラー発生]
- ❌ **本番環境**: [正常動作 / エラー発生]

### 再現条件
- **再現手順**:
  1. [ステップ1]
  2. [ステップ2]
  3. [ステップ3]
- **再現率**: [100% / 間欠的 / 特定条件下のみ]
- **以前の動作**: [以前は正常動作していた / 初回から問題があった]

### 影響範囲
- **影響を受けている機能**: [機能名]
- **影響を受けているユーザー**: [ユーザー数 / 全ユーザー]
- **ビジネスへの影響**: [影響度の説明]
```

### 確認事項

問題記録ドキュメントを作成したら、以下を確認してください：

- [ ] **背景情報がすべて記録されている**（環境構築の経緯、変更履歴、類似環境との比較、期待される動作との差分）
- [ ] 5W1H がすべて記録されている
- [ ] エラーメッセージが完全に記録されている
- [ ] 再現手順が明確に記録されている
- [ ] 環境別の動作状況が記録されている
- [ ] 影響範囲が明確に記録されている

**確認後、ユーザーに提示**: 「この問題記録で十分ですか？追加で記録すべき情報はありますか？」

---

## フェーズ 2: 仮説形成（症状から原因への体系的なアプローチ）

### 目的

症状から原因を体系的に推論し、検証可能な仮説を複数立てる。

### 実施内容

#### 2.1 症状の分析

記録された症状から、以下の観点で分析してください：

**エラーの種類**:

- ネットワークエラー（502, 503, 404, 500 など）
- アプリケーションエラー（例外、クラッシュ）
- データエラー（不正なデータ形式、null 参照）
- 環境エラー（設定ミス、依存関係の問題）
- UI エラー（表示崩れ、操作不能）

**エラーの発生タイミング**:

- 起動時
- 特定の操作時
- 特定の条件下
- 間欠的（ランダム）

**環境差分**:

- ローカルでは正常、本番でエラー
- 特定の環境でのみエラー
- 環境間で挙動が異なる

#### 2.2 原因カテゴリの特定

症状の分析結果から、以下のカテゴリで原因を分類してください：

**1. コードレベルの問題**:

- ロジックエラー（条件分岐、ループ処理）
- エラーハンドリング不足
- リソース管理の問題（メモリリーク、ファイルハンドル）
- 非同期処理の問題（競合状態、デッドロック）

**2. 設定・環境の問題**:

- 環境変数の設定ミス
- タイムアウト設定の不足
- リソース制限（メモリ、CPU、ディスク）
- ネットワーク設定の問題

**3. 依存関係の問題**:

- ライブラリのバージョン不整合
- 依存ライブラリのバグ
- プラットフォーム固有の問題

**4. データの問題**:

- 不正なデータ形式
- データの欠損
- データサイズの問題

**5. インフラ・デプロイの問題**:

- デプロイ時の問題
- インフラ設定の問題
- リバースプロキシの設定

#### 2.3 仮説の形成

各原因カテゴリから、具体的な仮説を 3-5 個立ててください。

**仮説の形式**:

```markdown
### 仮説 1: [原因カテゴリ] - [具体的な原因]

- **根拠**: [なぜこの仮説を立てたか]
- **検証方法**: [どのように検証するか]
- **優先度**: [高/中/低]
```

**仮説の優先順位付け**:

1. **発生確率**: 症状から最も可能性が高い原因
2. **検証の容易さ**: 簡単に検証できる原因から
3. **影響度**: 修正した場合の影響が大きい原因

#### 2.4 仮説リストの作成

以下のテンプレートを使用して、仮説リストを作成してください：

```markdown
## 想定される原因（調査前の仮説）

### 仮説 1: [原因カテゴリ] - [具体的な原因]

- **根拠**: [症状から推測される理由]
- **検証方法**: [ログ確認 / コード確認 / 設定確認 / 検証コード作成]
- **優先度**: 高

### 仮説 2: [原因カテゴリ] - [具体的な原因]

- **根拠**: [症状から推測される理由]
- **検証方法**: [ログ確認 / コード確認 / 設定確認 / 検証コード作成]
- **優先度**: 中

### 仮説 3: [原因カテゴリ] - [具体的な原因]

- **根拠**: [症状から推測される理由]
- **検証方法**: [ログ確認 / コード確認 / 設定確認 / 検証コード作成]
- **優先度**: 中

...
```

### 確認事項

仮説リストを作成したら、以下を確認してください：

- [ ] 仮説が 3-5 個立てられている
- [ ] 各仮説に根拠が記録されている
- [ ] 各仮説に検証方法が記録されている
- [ ] 優先順位が付けられている

**確認後、ユーザーに提示**: 「この仮説リストで検証を開始して問題ありませんか？追加の仮説はありますか？」

---

## チェックリスト

### フェーズ 1: 問題の明確化と記録

- [ ] **背景情報がすべて記録されている**（環境構築の経緯、変更履歴、類似環境との比較、期待される動作との差分）
- [ ] 5W1H がすべて記録されている
- [ ] エラーメッセージが完全に記録されている
- [ ] エラースタックトレースが記録されている
- [ ] 再現手順が明確に記録されている
- [ ] 環境別の動作状況が記録されている
- [ ] 影響範囲が明確に記録されている
- [ ] 問題記録ドキュメントが作成されている

### フェーズ 2: 仮説形成

- [ ] 症状が分析されている
- [ ] 原因カテゴリが特定されている
- [ ] 仮説が 3-5 個立てられている
- [ ] 各仮説に根拠が記録されている
- [ ] 各仮説に検証方法が記録されている
- [ ] 優先順位が付けられている
- [ ] 仮説リストが作成されている

---

## 次のステップ

調査フェーズが完了したら、**検証フェーズ**（`02_検証フェーズ（フェーズ3）.md`）に進んでください。
