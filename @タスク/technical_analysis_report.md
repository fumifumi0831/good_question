# 技術分析レポート: 実装の特性と設計合理性の分析

## 1. 調査の目的
- **Why**: 実装された「柔軟なファシリテーション」「堅牢なデータ抽出」「Markdown統合型UI」の技術的背景を言語化し、横展開可能な知見として蓄積するため。
- **What**: 状態ベースのプロンプト設計、タグベースの抽出ロジック、およびReactステート管理の整合性を明らかにします。
- **調査日**: 2025-12-23

## 2. 調査結果サマリー
今回の実装では、LLMの「指示への忠実性」と「出力の不確実性」のトレードオフを解消するため、**「状態主導型プロンプト設計」と「多重フォールバック抽出ロジック」**を採用しました。これにより、UXの柔軟性（10回制限の撤廃）と、評価データの正確な可視化を両立しています。

## 3. 主要な発見（重要度順）

### ① 状態主導型（State-Driven）プロンプト設計
- **概要**: 「残り回数」という静的な数値制約を排除し、現在の対話状況（状態）に基づいてフェーズ移行を判断する設計への転換。
- **根拠**: AIが「10回」という数字に固執して早期終了を拒否する「ハルシネーション的制約」を解消するため。
- **実装への影響**: ユーザーの意思（またはAIの判断）による動的なセッション終了が可能になり、UXの自由度が劇的に向上。

### ② タグベース + 正規表現の多重抽出ロジック
- **概要**: \`[GOOD_QUESTIONS]\` 等の明確な独自タグを第一優先とし、従来のセクション見出しをフォールバックとする \`extractRobust\` 関数の実装。
- **根拠**: AIの出力形式がMarkdownの微差（太字、空白等）で変動しても、確実にフロントエンドでデータをキャッチするため。
- **実装への影響**: 「解析結果が見つかりません」というエラーを最小化し、データの可視化精度を担保。

### ③ セマンティックMarkdown UI
- **概要**: 独自の装飾線（━━━━）を廃止し、セマンティックなMarkdownヘッダー（\`###\`）とCSSコンポーネントによるデザイン表現への統合。
- **根拠**: RAWテキスト表示とMarkdownレンダリングの不一致を防ぎ、モバイル画面等でのレイアウト崩れ（Overflow）を防止するため。
- **実装への影響**: チャット欄でのAI回答がプレミアムな外見に整理され、レスポンシブ対応も容易に。

---

## 4. 技術の内部処理・動作原理

### セッションフェーズ管理の動作原理
会話履歴全体のメタデータとユーザーの特定入力を合図に、AIの役割を「ファシリテーター」から「評価者」へ動的に切り替える。

- **主要コンポーネント**:
    - \`systemprompt.md\`: 状態遷移の定義とタグ出力の強制。
    - \`page.tsx\`: 終了トリガーの発信と、API応答の非同期パース。
- **処理フロー**:
    1. ユーザーが「真因を提出」または「評価を依頼」
    2. システムが「評価用フラグ」を付与した最終プロンプトを生成
    3. AIが構造化タグ（\`[SCORE]\`等）を含む総評を出力

> **技術の強み**: プロンプトを分断せず、文脈を維持したまま自然な流れで評価フェーズへ移行できる。

---

## 5. 課題解決メカニズム

| 顧客の課題 | 技術が提供する機能 | 解決の概要 |
| :--- | :--- | :--- |
| **AIが10回ルールを破れない** | 指示のトーン変更と終了フラグ | 数値制約を「状態制約」に置換し、AIの拒絶を回避 |
| **評価結果が表示されない** | \`extractRobust\` (Regex fallback) | 一致率が高いタグ方式と柔軟な見出しパースを併用 |
| **表示がガタガタになる** | Tailwind CSS & Markdown Component | 装飾をCSSに、構造をMarkdownに役割分担 |

---

## 6. 技術選択の根拠（Architecture Decision）

### なぜ JSON API ではなくタグベースのテキスト出力か？
- **背景**: 会話全体の流れを維持しながら、最終回答の一部だけを構造化して抽出する必要があった。
- **理由**: Gemini のようなLLMにおいて、思考プロセス（Facilitation）と結果出力（Tags）を一つのストリームで行う方が、コンテキストの欠落が少なく、トークンコストも抑えられるため。

### なぜ LocalStorage と IndexedDB のハイブリッドか？
- **理由**: スコアやレベルなどの「軽量なメタデータ」は即時性のある LocalStorage、会話履歴などの「増大するデータ」はブラウザを重くしない IndexedDB (Dexie) と使い分けることで、将来的なクラウド同期への拡張性とパフォーマンスを両立。

---

## 7. 不明点・深堀りポイントの提案
- **抽出精度の限界**: AIがタグ自体を出力し忘れた場合の高度なリトライ（例：JSONモードでの再生成）は必要か？
- **オフライン体験**: IndexedDB を用いた「完全オフラインでのプレイ継続」のニーズはあるか？
- **プロンプトの肥大化**: 柔軟性を高めた分、システムプロンプトが長くなっている。プロンプトエンジニアリングによる「軽量化」の余地
